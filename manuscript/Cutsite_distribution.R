# custom COV-ID19 genome creation

require(karyoploteR)
require(data.table)
require(GenomicRanges)
require(dplyr)
source("/mnt/AchTeraD/Documents/R-functions/save_and_plot.R")

#sequencing method
#se = 150
pe = 75

covid_gr = GRanges(seqnames = "COVID-19", ranges = IRanges(start = 1, end = 29903))
#covid_gr = GRanges(seqnames = "COVID-19", ranges = IRanges(start = 21563, end = 25384)) #for S only

annot = data.table(chr = rep("COVID-19", 12),
                   start = c(1, 266, 21563, 25393, 26245, 26523, 27202, 27394, 27894, 28274, 29558, 29675),
                   end = c(265, 21555, 25384, 26220, 26472, 27191, 27387, 27759, 28259, 29533, 29674, 29903),
                   annot = c("5` UTR", "ORF1ab", "S", "ORF3a", "E", "M", "ORF6", "ORF7a", "ORF8", "N", "ORF10", "3` UTR"),
                   gieStain = c("gneg", "gpos50", "acen", "gpos75", "gneg", "gvar", "gpos25", "stalk", "gneg", "acen", "gpos50", "gpos75"))

cutsites = GRanges(seqnames = "COVID-19", ranges = IRanges(start = c(109, 509, 515, 596, 787, 903, 968, 974, 1228,
                                                                     1257, 1383, 2458, 3467, 3514, 3614, 4409, 4631, 5023, 5105, 5206, 5480,
                                                                     5578, 5720, 6245, 6641, 7042, 7306, 7463, 8314, 8422, 8496, 8648, 8653,
                                                                     8759, 8775, 9136, 9441, 9494, 10178, 10201, 10488,10540, 10571, 10793,
                                                                     11165, 11262, 11464, 11521, 12028, 12256, 12636, 13435, 13687, 13738,
                                                                     13770, 14028, 14209, 15243, 15318,15327, 15444, 15871, 16117, 16137,
                                                                     16146, 16336, 16526, 16571, 16736, 17170, 17544, 17683, 18186, 18255,
                                                                     18286, 18296, 18325,18604, 18686, 18811, 18832, 18844, 18867, 18984,
                                                                     19312, 19394, 19405, 19501, 19539, 20632, 21210, 21224, 21330, 21334,
                                                                     21399,21761, 21770, 23120, 23331, 23438, 23528, 24737, 24755, 24812,
                                                                     25203, 25939, 26074, 26122, 26525, 26614, 26849, 26898, 27396, 27896,
                                                                     27967, 28230, 28451, 29239, 29506, 29540, 29841), width = 4))
cutsites = GRanges(seqnames = "COVID-19", ranges = IRanges(start = c(2, 77, 133, 402, 795, 867, 1035, 1094, 1275, 1362, 1602, 1665, 1671, 1791,
                                                                     2169, 2211, 2277, 2301, 2364, 2427, 2519, 2619, 2823, 3006, 3359, 3384, 3438,
                                                                     3459, 3488, 3555, 3578, 3630, 3657, 3678, 3749, 3897, 4041, 4100, 4151, 4265,
                                                                     4302, 4427, 4491, 4578, 4634, 4848, 4932, 4968, 4995, 5213, 5247, 5255, 5265,
                                                                     5306, 5334, 5550, 5601, 5712, 6048, 6086, 6095, 6129, 6152, 6201, 6246, 6495,
                                                                     6515, 6585, 6654, 6702, 6746, 6834, 6873, 6909, 6971, 6992, 7022, 7206, 7217,
                                                                     7364, 7371, 7545, 7623, 7695, 7830, 7878, 8028, 8049, 8070, 8229, 8361, 8409,
                                                                     8484, 8517, 8544, 8562, 8582, 8586, 8630, 9030, 9282, 9504, 9545, 9765, 9818,
                                                                     10134, 10203, 10314, 10320, 10461, 10476, 10503, 10659, 10734, 10743, 10856,
                                                                     11214, 11295, 11790, 12195, 12656, 12957, 12965, 13149, 13298, 13359, 13463,
                                                                     13633, 13655, 13709, 13745, 13831, 13864, 13999, 14161, 14173, 14191, 14221,
                                                                     14237, 14251, 14278, 14300, 14336, 14378, 14543, 14684, 14726, 14749, 14903,
                                                                     14957, 15071, 15244, 15464, 15521, 15551, 15785, 15899, 16123, 16276, 16370,
                                                                     16553, 16670, 16763, 16891, 16939, 17200, 17618, 17651, 17699, 17918, 18062,
                                                                     18218, 18236, 18383, 18476, 18547, 18560, 18899, 18953, 18989, 19052, 19265,
                                                                     19349, 19354, 19640, 19700, 19772, 19808, 20063, 20105, 20119, 20228, 20393,
                                                                     20444, 20818, 20827, 20911, 20957, 21274, 21413, 21418, 21442, 21545, 21609,
                                                                     21819, 21921, 21945, 22143, 22164, 22191, 22260, 22391, 22587, 22692, 22721,
                                                                     23019, 23163, 23198, 23406, 23510, 23849, 23861, 23943, 23961, 24126, 24279,
                                                                     24342, 24437, 24450, 24491, 24596, 25029, 25077, 25139, 26159, 26278, 26285,
                                                                     26384, 26429, 26511, 26560, 26668, 26673, 27138, 27266, 27311, 27384, 27484,
                                                                     27771, 27819, 28062, 28156, 28464, 28494, 29655, 29661, 29681, 29816, 29847), width = 4))

# cutsites = GRanges(seqnames = "COVID-19", ranges = IRanges(start = c(2, 77, 133, 402, 795, 867, 1035, 1094, 1275, 1362, 1602, 1665, 1671, 1791, 
#                                                                      2169, 2211, 2277, 2301, 2364, 2427, 2519, 2619, 2823, 3006, 3359, 3384, 3438, 
#                                                                      3459, 3488, 3555, 3578, 3630, 3657, 3678, 3749, 3897, 4041, 4100, 4151, 4265, 
#                                                                      4302, 4427, 4491, 4578, 4634, 4848, 4932, 4968, 4995, 5213, 5247, 5255, 5265, 
#                                                                      5306, 5334, 5550, 5601, 5712, 6048, 6086, 6095, 6129, 6152, 6201, 6246, 6495, 
#                                                                      6515, 6585, 6654, 6702, 6746, 6834, 6873, 6909, 6971, 6992, 7022, 7206, 7217, 
#                                                                      7364, 7371, 7545, 7623, 7695, 7830, 7878, 8028, 8049, 8070, 8229, 8361, 8409, 
#                                                                      8484, 8517, 8544, 8562, 8582, 8586, 8630, 9030, 9282, 9504, 9545, 9765, 9818, 
#                                                                      10134, 10203, 10314, 10320, 10461, 10476, 10503, 10659, 10734, 10743, 10856, 
#                                                                      11214, 11295, 11790, 12195, 12656, 12957, 12965, 13149, 13298, 13359, 13463, 
#                                                                      13633, 13655, 13709, 13745, 13831, 13864, 13999, 14161, 14173, 14191, 14221, 
#                                                                      14237, 14251, 14278, 14300, 14336, 14378, 14543, 14684, 14726, 14749, 14903, 
#                                                                      14957, 15071, 15244, 15464, 15521, 15551, 15785, 15899, 16123, 16276, 16370, 
#                                                                      16553, 16670, 16763, 16891, 16939, 17200, 17618, 17651, 17699, 17918, 18062, 
#                                                                      18218, 18236, 18383, 18476, 18547, 18560, 18899, 18953, 18989, 19052, 19265, 
#                                                                      19349, 19354, 19640, 19700, 19772, 19808, 20063, 20105, 20119, 20228, 20393, 
#                                                                      20444, 20818, 20827, 20911, 20957, 21274, 21413, 21418, 21442, 21545, 21609, 
#                                                                      21819, 21921, 21945, 22143, 22164, 22191, 22260, 22391, 22587, 22692, 22721, 
#                                                                      23019, 23163, 23198, 23406, 23510, 23849, 23861, 23943, 23961, 24126, 24279, 
#                                                                      24342, 24437, 24450, 24491, 24596, 25029, 25077, 25139, 26159, 26278, 26285, 
#                                                                      26384, 26429, 26511, 26560, 26668, 26673, 27138, 27266, 27311, 27384, 27484, 
#                                                                      27771, 27819, 28062, 28156, 28464, 28494, 29655, 29661, 29681, 29816, 29847, 
#                                                                      109, 509, 515, 596, 787, 903, 968, 974, 1228,
#                                                                      1257, 1383, 2458, 3467, 3514, 3614, 4409, 4631, 5023, 5105, 5206, 5480,
#                                                                      5578, 5720, 6245, 6641, 7042, 7306, 7463, 8314, 8422, 8496, 8648, 8653,
#                                                                      8759, 8775, 9136, 9441, 9494, 10178, 10201, 10488,10540, 10571, 10793,
#                                                                      11165, 11262, 11464, 11521, 12028, 12256, 12636, 13435, 13687, 13738,
#                                                                      13770, 14028, 14209, 15243, 15318,15327, 15444, 15871, 16117, 16137,
#                                                                      16146, 16336, 16526, 16571, 16736, 17170, 17544, 17683, 18186, 18255,
#                                                                      18286, 18296, 18325,18604, 18686, 18811, 18832, 18844, 18867, 18984,
#                                                                      19312, 19394, 19405, 19501, 19539, 20632, 21210, 21224, 21330, 21334,
#                                                                      21399,21761, 21770, 23120, 23331, 23438, 23528, 24737, 24755, 24812,
#                                                                      25203, 25939, 26074, 26122, 26525, 26614, 26849, 26898, 27396, 27896,
#                                                                     27967, 28230, 28451, 29239, 29506, 29540, 29841), width = 4))
values(cutsites) = data.table(enzyme = "")


#plot distribution
# setEPS()
# cairo_ps("/mnt/AchTeraD/Documents/Projects/COVID19/Plots/COVID19_cutsite_distribution_no-offset_cairo_ps.eps",
#          onefile = TRUE, height=6, width=8, family="Helvetica",
#          pointsize=8)
# kp = plotKaryotype(genome = covid_gr, cytoband = annot)
# kpPlotMarkers(kp, data = cutsites, labels = cutsites$enzyme,
#               adjust.label.position = F, r0 = -0.1, r1 = 0.1, cex = 0.6)
# dev.off()

#Calculate theoretical coverage
values(cutsites) = data.table(enzyme = "MseI")
cutsites = as.data.table(cutsites)

#get new tables
cutsites_pe = copy(cutsites)
#cutsites_se = copy(cutsites)

#calculate pe coverage
cutsites_pe[, start := start - pe]
cutsites_pe[, end := end + pe]
cutsites_pe[start < 0, start := 0]
cutsites_pe[end > 29903, end := 29903]
cutsites_pe = makeGRangesFromDataFrame(cutsites_pe, keep.extra.columns = T)

#calculate se coverage
#
# 
#

#plot and save it
# setEPS()
# cairo_ps(paste0("/mnt/AchTeraD/Documents/Projects/COVID19/Plots/COVID19_coverage_pe", pe, "_cairo_ps.eps"),
#          onefile = TRUE, height=6, width=8, family="Helvetica",
#          pointsize=8)
# kp = plotKaryotype(genome = covid_gr, cytoband = annot)
# kpPlotCoverage(kp, data = cutsites_pe, r0 = -0.05, r1 = 0.6)
# dev.off()
# 
# setEPS()
# cairo_ps(paste0("/mnt/AchTeraD/Documents/Projects/COVID19/Plots/COVID19_coverage_se", se, "_cairo_ps.eps"),
#          onefile = TRUE, height=6, width=8, family="Helvetica",
#          pointsize=8)
# kp = plotKaryotype(genome = covid_gr, cytoband = annot)
# kpPlotCoverage(kp, data = cutsites_se, r0 = -0.05, r1 = 0.6)
# dev.off()

# get per base data.table
covid_bp = data.table(seqnames = "COVID-19", start = c(21563:25384), end = c(21563:25384))

#go back to DT and set keys for SE
#Get values for PE
cutsites_pe = as.data.table(cutsites_pe)
setkey(covid_bp, seqnames, start, end)
setkey(cutsites_pe, seqnames, start, end)

#give coverage 'score' and overlap
cutsites_pe[, score := 1]
covid_pe = foverlaps(covid_bp, cutsites_pe)
covid_pe = covid_pe[, c(1, 8, 9, 7)]

#sum the score for duplicate rows
covid_pe = covid_pe %>% group_by(seqnames, i.start, i.end) %>% summarise_all(sum)
covid_pe = as.data.table(covid_pe)
covid_pe[is.na(score), score := 0]

#get percentage
perc_1 = nrow(covid_pe[score >= 1]) / nrow(covid_pe) * 100
perc_2 = nrow(covid_pe[score >= 2]) / nrow(covid_pe) * 100
